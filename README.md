

Проект для работы с коэффициентами складов
==========================================

Этот проект включает в себя сервис для работы с коэффициентами складов, взаимодействие с Google Sheets для загрузки данных и интеграцию с API для получения информации о складах.

Структура проекта
-----------------

Проект включает следующие компоненты:

*   **KnexService**: Сервис для работы с базой данных и коэффициентами.
*   **AppService**: Основной сервис, который управляет данными и обновлениями.
*   **GoogleSheetsService**: Сервис для загрузки данных в Google Sheets.
*   **AppController**: Эндпоинт для ручного тестирования обновления данных.

Установка и настройка
---------------------

### Шаг 1: Клонируйте репозиторий

        git clone <URL вашего репозитория>
        cd <папка проекта>


### Шаг 2: Установите зависимости

        npm install


### Шаг 3: Настройка переменных окружения

Создайте файл `.env` в корне проекта и добавьте следующие переменные:

        WB\_API\_URL=<URL для API получения данных>
        WB\_API\_KEY=<API ключ>
        GOOGLE\_SHEET\_ID=<ID вашего Google Spreadsheet>
        POSTGRES\_HOST=<host для базы данных PostgreSQL>
        POSTGRES\_PORT=<порт PostgreSQL>
        POSTGRES\_USER=<пользователь базы данных>
        POSTGRES\_PASSWORD=<пароль базы данных>
        POSTGRES\_DB=<название базы данных>


### Шаг 4: Настройка Google API

Для работы с Google Sheets вам нужно создать учетные данные в Google Cloud Console:

*   Перейдите в [Google Cloud Console](https://console.cloud.google.com/).
*   Создайте проект и включите API Google Sheets.
*   Создайте сервисный аккаунт и загрузите ключ JSON.
*   Добавьте созданный сервисный аккаунт в качестве редактора к вашему Google Spreadsheet.

После этого, поместите файл конфигурации сервисного аккаунта (JSON) в папку проекта. Название файла должно быть `google-api-key.json`.



### Шаг 5: Запуск проекта

#### Запуск локально

        npm run start



### Шаг 6: Миграции

Для создания всех необходимых таблиц в базе данных выполните миграции:

        npm run knex:migrate


### Шаг 7: Запуск обновлений вручную через API

Чтобы вручную обновить данные, используйте POST-запрос на эндпоинт:

        POST /update


Пример с использованием Postman:

*   URL: `http://localhost:3000/update`
*   Метод: `POST`

При запросе к этому эндпоинту будет вызвана функция обновления данных, которая выполнит следующие шаги:

*   Проверит наличие данных за текущую дату.
*   Если данные не найдены, то загрузит их через API.
*   Если данные существуют, обновит их в базе данных.

### Шаг 8: Регулярное обновление данных через Cron

Данные обновляются автоматически каждый час через Cron задачу, которая запускает метод `updateData`:

        @Cron('0 \* \* \* \*')
        async updateData() {
            // Логика обновления данных
        }


Это гарантирует, что данные в базе будут актуальными.

Пример работы с API:
--------------------

*   Эндпоинт: `/update`
*   Метод: `POST`
*   Описание: Обновление данных о коэффициентах для всех складов.

Технологии
----------

*   **NestJS**: Фреймворк для построения серверных приложений.
*   **Knex.js**: SQL-генератор для работы с базой данных.
*   **Google Sheets API**: Используется для загрузки данных в таблицу Google.
*   **PostgreSQL**: СУБД для хранения данных.

Структура базы данных
---------------------

Проект использует следующие таблицы для хранения коэффициентов для различных складов:

*   `overallcoefs`
*   `deliverybase`
*   `deliveryliter`
*   `storagebase`
*   `storageliter`

Каждая таблица имеет следующие поля:

*   `warehouse`: Название склада.
*   `date`: Дата.
*   `coef`: Коэффициент для склада.

